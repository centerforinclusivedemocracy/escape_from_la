<!DOCTYPE html> 
<html> 
<!-- Define Head section, with links and scripts for use in Body -->
<head> 
<meta charset="utf-8" /> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

      
<!-- Get the leaflet CSS/JS sources -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Get our internal CSS file -->
<link rel="stylesheet" href="style.css">

<!-- Get the AJAX source -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="leaflet.ajax.min.js" type="text/javascript" ></script>

<!-- Get Bootstrap for CID loading spinners -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">    

<!-- Add jQuery -->
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- <Add FontAwesome Icons -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet-src.js" integrity="sha512-IkGU/uDhB9u9F8k+2OsA6XXoowIhOuQL1NTgNZHY1nkURnqEGlDZq3GsfmdJdKFe1k1zOc6YU2K7qY+hF9AodA==" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.css" />
<script src="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.js"></script>
<link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">

<!--Get Geocoder source-->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!--Get EasyButton source-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

<link rel="stylesheet" href="files/leaflet-control-zoombar.css" />
<script src="files/leaflet-control-zoombar.js"></script>
<script src="files/sitewide.js"></script>
<link rel="stylesheet" href="files/leaflet-control-basemapbar.css" />
<script src="files/leaflet-control-basemapbar.js"></script>
<!-- <script src="files/index.js"></script> -->
<!-- <script src="files/county.js"></script> -->
<script src="files/leaflet-control-legend-statewidemap.js"></script>
</head> 

<body>

<!-- CID loading screen for webpage -->
<div id="loading" style="text-align:center;">
    <img id="loading-image" src="CID.png" alt="Loading..." style="text-align:center;"/>
    <h3 style="text-align:center;">Loading approximately 250,000 precinct polygons for Los Angeles County... please allow several seconds to load.</h3>
    <div class="spinner-border slow text-danger" style="width: 13rem; height: 13rem;" role="status">
        <span class="sr-only">Loading...</span>
        </div>
    <div class="spinner-border slow text-dark" style="width: 13rem; height: 13rem;" role="status">
    <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-border slow text-warning" style="width: 13rem; height: 13rem;" role="status">
    <span class="sr-only">Loading...</span>
    </div>
</div> 

<!-- jQuery to close CID loading screen when page has loaded -->
<script>
    $(window).load(function() {
        $('#loading').hide();
    });
</script> 

<!-- Specify the map and it's dimensions -->
<div id="map"></div>

<!-- Load the precint/vote center GeoJSONs and enable JS code below  -->
<script type="text/javascript" src="la_precincts.geojson"></script>
<script type="text/javascript" src="vote_centers.geojson"></script>
<script type="text/javascript"> 

$(document).ready(function () {
    initStatewideMap();
});

let MAP;

function initStatewideMap () {
    // the map, a fixed basemap, a labels overlay, and our special map controls
    // note the ZoomBar which we add after we have GeoJSON data and therefore a home extent

MAP = L.map('map', {
    zoomControl: false,
    maxZoom: 18,
    minZoom: 6,
});

L.control.scale({
    position: 'bottomleft',
    updateWhenIdle: true
})
.addTo(MAP);

MAP.BASEMAPBAR = new L.Control.BasemapBar({
    position: 'topright',
    layers: BASEMAP_OPTIONS,
})
.addTo(MAP)
.selectLayer(BASEMAP_OPTIONS[0].label);

$.get('files/counties.js', function (data) {
    MAP.COUNTYOVERLAY = L.geoJson(data, {
        style: function (feature) {
            let countyinfo;
            try {
                countyinfo = getParticipatingCountyInfo(feature.properties.countyfp);
            } catch (error) {}  // catch = leave undefined, it's OK

            if (! countyinfo) return BOUNDSTYLE_DEFAULT;  // not participating, default style

            switch (countyinfo.profile) {
                case 'fullmodelGIN':
                case 'fullmodelCID':
                case 'fullmodelTEMP':
                case 'fullexceptsuggested':
                    return BOUNDSTYLE_FULL;
                case 'lite':
                    return BOUNDSTYLE_LITE;
                default:
                    console.error(`County ${countyinfo.countyfp} has unknown profile '${countyinfo.profile}' for styling map`);
                    return BOUNDSTYLE_DEFAULT;  // not known, so punt with this and the error message
            }
        },
        onEachFeature: function (feature, layer) {
            // tooltip = the county name and invitation to click
            let countyinfo;
            try {
                countyinfo = getParticipatingCountyInfo(feature.properties.countyfp);
            } catch (error) {}  // catch = leave undefined, it's OK


            let message = 'Not analyzed';
            if (countyinfo) {
                switch (countyinfo.profile) {
                    case 'fullmodel':
                    case 'fullmodelGIN':
                    case 'fullexceptsuggested':
                        message = 'Suggested Voting Centers';
                        break;
                    case 'fullmodelCID':
                    case 'fullmodelTEMP':
                        message = 'Suggested Voting Locations';
                        break;
                    case 'lite':
                        message = 'Community-Level Demographic and Voter Data';
                        break;
                    default:
                        console.error(`County ${countyinfo.countyfp} has unknown profile '${countyinfo.profile}' for creating tooltip`);
                        message = 'Unknown status';
                        break;
                }
            }

            const popupcontent = `<h1>${feature.properties.name}</h1>${message}`;

            layer.bindTooltip(popupcontent, { sticky: true });

            // click = go to the page
            if (countyinfo) {
                const url = `county.html?county=${feature.properties.countyfp}`;
                layer.on('click', function () { document.location.href = url; });
            }
        },
    })
    .addTo(MAP);

    const bbox = MAP.COUNTYOVERLAY.getBounds();
    MAP.fitBounds(bbox);

    // now that we have a home bounds, add the zoom+home control then the geocoder control under it (they are positioned in sequence)
    MAP.ZOOMBAR = new L.Control.ZoomBar({
        position: 'topright',
        homeBounds: bbox,
    }).addTo(MAP);

    // MAP.GEOCODER = L.Control.geocoder({
    //     position: 'topright',
    //     showUniqueResult: false,
    //     defaultMarkGeocode: false,
    //     placeholder: 'Search for address or place',
    //     collapsed: true,  // control is buggy if expanded, won't close results list
    // })
    // .on('markgeocode', function (event) {
    //     MAP.fitBounds(event.geocode.bbox);
    // })
    // .addTo(MAP);
}, 'json');
}

// Call the Leaflet JS functions
// var MAP = L.map(
//             "map",
//             {
//                 center: [34.0, -118.3],
//                 crs: L.CRS.EPSG3857,
//                 zoom: 12,
//                 zoomControl: false,
//                 preferCanvas: true,
//             }
//         );
// L.control.scale().addTo(MAP);
// var tile_layer = L.tileLayer(
//             "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
//             {"attribution": "Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 7, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
//         ).addTo(MAP);



// Create precint polygons
// var polygons = L.geoJson(la, {
//     style: style,
//     onEachFeature: onEachFeature
// }).addTo(map);

function style(feature) {
    return {
        // fillColor: getColor(feature.properties.pctvote),
        weight: 1,
        opacity: .25,
        color: '#4a4c4f',
        fillOpacity: 0.7
    };
}

function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
			weight: 2.5,
			color: '#666',
            opacity: .75,
			dashArray: '',
			fillOpacity: 0.2
		});

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }
}

function resetHighlight(e) {
    map.COUNTYOVERLAY.resetStyle(e.target);
}

function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });
}

</script>
</body> 
</html> 